@using Core
@inject HttpClient Http
@using BlazorApp.Service
@page "/CreateUser"

<div class="login-page-background">
    <div class="login-container">
        
        <h3>Opret Bruger</h3>
        
        <EditForm Model="@user">
            <DataAnnotationsValidator/>
            
            <div class="form-floating-group gap-1">
                <label for="un">Username</label>
                <InputText id="un" class="form-control" @bind-Value="user.Name" placeholder="Username"/>
            </div>
            <br/>
            <div class="form-floating-group gap-1">
                <label for="pwd">Adgangskode</label>
                <InputText id="pwd"
                           type="@PasswordType"
                           class="form-control"
                           @bind-Value="user.Password"
                           placeholder="Password"/>
                <i class="bi bi-eye" @onclick="ToggleAdgangskodeVisibility"></i>
            </div>
            <br/>
            <div class="form-floating-group gap-1">
                <label for="un">E-Mail</label>
                <InputText id="em" class="form-control" @bind-Value="user.Email" placeholder="E-Mail"/>
            </div>
            <br/>
            <div class="form-floating-group gap-1">
                <label for="un">Adresse</label>
                <InputText id="ad" class="form-control" @bind-Value="user.Adress" placeholder="Adresse"/>
            </div>
            <br/>
            <div class="form-floating-group gap-1">
                <label for="un">Tlf nummer</label>
                <InputText id="pn" class="form-control" @bind-Value="user.Phone" placeholder="Tlf nummer"/>
            </div>
            <br/>
            <div>
                <button type="submit" class="btn btn-primary" @onclick="OnClickCreateUser">Opret Bruger</button>
            </div>
            
        </EditForm>

        @if (!string.IsNullOrEmpty(errorText))
        {
            <div class="error-message">
                <span class="error-icon">⚠️</span>
                <span class="error-text">@errorText</span>
            </div>
        }
    </div>
</div>

@code {
    private User user = new();          // single user bound to the form
    private string errorText = "";      // show any error

    protected override Task OnInitializedAsync()
    {
        // No need to fetch a list here for a create page
        return Task.CompletedTask;
    }

    private string PasswordType => visPassword ? "text" : "password";
    private bool visPassword = false;

    private void ToggleAdgangskodeVisibility() => visPassword = !visPassword;

    private async Task OnClickCreateUser()
    {
        errorText = "";
        try
        {
            var response = await Http.PostAsJsonAsync("http://localhost:5157/api/bruger", user);

            if (response.IsSuccessStatusCode)
            {
                // clear the form after successful create
                user = new User();
            }
            else
            {
                errorText = $"Kunne ikke oprette bruger (status { (int)response.StatusCode }).";
            }
        }
        catch
        {
            errorText = "Fejl ved forbindelse til API'et.";
        }
    }
}